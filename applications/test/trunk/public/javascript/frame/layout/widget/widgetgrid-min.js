YUI.add("widgetgrid",function(Y){function WidgetGrid(oCfg,oLayout,aMetaData){WidgetGrid.superclass.constructor.apply(this,arguments)}WidgetGrid.NAME="WidgetGrid";WidgetGrid.ATTRS={oDataSet:{value:null},iRowIndex:{value:-1},sPrintLabel:{value:"Print"},sExportLabel:{value:"Excel Export"},sAddRowLabel:{value:"Add Row"},sDeleteRowLabel:{value:"Delete Row"},sSuffixAddButton:{value:"-addbutton"},sSuffixDeleteButton:{value:"-deletebutton"},sSuffixExportButton:{value:"-excelbutton"},sSuffixPrintButton:{value:"-printbutton"},aIds:{value:[]},bNewId:{value:false},sTheme:{value:""},iRowsHeight:{value:25},iWidth:{value:600},iHeight:{value:400},bSortable:{value:false},bFilterRow:{value:false},bColumnResize:{value:false},bFilterable:{value:false},iColumnsHeight:{value:25},bShowStatusBar:{value:false},iStatusBarHeight:{value:25},bShowAggregates:{value:false},sDeleteMsg:{value:"Confirm the deletion ?"},oComputedColumns:{value:{}},iComputedIndex:{value:0},sDecimalSeparator:{value:","},sThousandSeparator:{value:" "},sCountLabel:{value:"Nb de lignes"},sSumLabel:{value:"Total"},sAvgLabel:{value:"Moyenne"}};Y.WidgetGrid=Y.extend(WidgetGrid,Y.WidgetBase,{initializer:function(){var oWidgetDef=this.get("oWidgetDef");this.set("oDataSet",this.Layout().Frame().DataSetManager().DataSet(oWidgetDef.d));if(oWidgetDef.options.aggregates_count_label!=undefined){this.set("sCountLabel",oWidgetDef.options.aggregates_count_label)}if(oWidgetDef.options.aggregates_avg_label!=undefined){this.set("sAvgLabel",oWidgetDef.options.aggregates_avg_label)}if(oWidgetDef.options.aggregates_sum_label!=undefined){this.set("sSumLabel",oWidgetDef.options.aggregates_sum_label)}if(oWidgetDef.options.export_btn_label!=undefined){this.set("sExportLabel",oWidgetDef.options.export_btn_label)}if(oWidgetDef.options.deleterow_btn_label!=undefined){this.set("sDeleteRowLabel",oWidgetDef.options.deleterow_btn_label)}if(oWidgetDef.options.addrow_btn_label!=undefined){this.set("sAddRowLabel",oWidgetDef.options.addrow_btn_label)}if(oWidgetDef.options.print_btn_label!=undefined){this.set("sPrintLabel",oWidgetDef.options.print_btn_label)}if(oWidgetDef.options.deleterow_warning!=undefined){this.set("sDeleteMsg",oWidgetDef.options.deleterow_warning)}if(oWidgetDef.options.theme!=undefined){this.set("sTheme",oWidgetDef.options.theme)}if(oWidgetDef.options.rowsheight!=undefined){this.set("iRowsHeight",oWidgetDef.options.rowsheight)}if(oWidgetDef.options.columnsheight!=undefined){this.set("iColumnsHeight",oWidgetDef.options.columnsheight)}if(oWidgetDef.options.width!=undefined){this.set("iWidth",oWidgetDef.options.width)}if(oWidgetDef.options.height!=undefined){this.set("iHeight",oWidgetDef.options.height)}if(oWidgetDef.options.sortable!=undefined){this.set("bSortable",Boolean(oWidgetDef.options.sortable))}if(oWidgetDef.options.showfilterrow!=undefined){this.set("bFilterRow",Boolean(oWidgetDef.options.showfilterrow))}if(oWidgetDef.options.columnresize!=undefined){this.set("bColumnResize",Boolean(oWidgetDef.options.columnresize))}var filterable=false;if(oWidgetDef.options.filterable!=undefined){filterable=Boolean(oWidgetDef.options.filterable)}if(this.get("bFilterRow")){filterable=true}this.set("bFilterable",filterable);if(oWidgetDef.options.statusbarheight!=undefined){this.set("iStatusBarHeight",Boolean(oWidgetDef.options.statusbarheight))}if(oWidgetDef.options.showaggregates!=undefined){this.set("bShowAggregates",Boolean(oWidgetDef.options.showaggregates))}var showstatusbar=false;if(oWidgetDef.options.showstatusbar!=undefined){showstatusbar=Boolean(oWidgetDef.options.showstatusbar)}if(this.get("bShowAggregates")){showstatusbar=true}this.set("bShowStatusBar",showstatusbar)},Render:function(sNodeId){var suffix="-gridbtns";var theme=this.get("sTheme");var listClassName=" jqx-reset jqx-reset-"+theme+" jqx-rc-all jqx-rc-all-"+theme+" jqx-widget jqx-widget-"+theme+" jqx-widget-content jqx-widget-content-"+theme;var listStyle="margin-top: 20px";var btnClassName=" jqx-rc-all jqx-rc-all-"+theme+" jqx-widget jqx-widget-"+theme+" jqx-button jqx-button-"+theme+" jqx-fill-state-pressed + jqx-fill-state-pressed-"+theme;var btnStyle="margin-left: 5px";Y.one("#"+sNodeId).append('<div id="'+this.UniqId()+'"></div>');Y.one("#"+sNodeId).append('<div id="'+this.UniqId()+suffix+'" class="'+listClassName+'" style="'+listStyle+'"></div>');Y.one("#"+this.UniqId()+suffix).append('<input id="'+this.UniqId()+this.get("sSuffixAddButton")+'" class="'+btnClassName+'" style="'+btnStyle+'" type="button" value="'+this.get("sAddRowLabel")+'">');Y.one("#"+this.UniqId()+suffix).append('<input id="'+this.UniqId()+this.get("sSuffixDeleteButton")+'" class="'+btnClassName+'" style="'+btnStyle+'" type="button" value="'+this.get("sDeleteRowLabel")+'">');Y.one("#"+this.UniqId()+suffix).append('<input id="'+this.UniqId()+this.get("sSuffixExportButton")+'" class="'+btnClassName+'" style="'+btnStyle+'" type="button" value="'+this.get("sExportLabel")+'">');Y.one("#"+this.UniqId()+suffix).append('<input id="'+this.UniqId()+this.get("sSuffixPrintButton")+'" class="'+btnClassName+'" style="'+btnStyle+'" type="button" value="'+this.get("sPrintLabel")+'">')},PostRender:function(){WidgetGrid.superclass.PostRender.apply(this,arguments);this.Initialize();$("#"+this.UniqId()).jqxGrid("focus")},DataSet:function(){return this.get("oDataSet")},DataSetChangeEvent:function(oDataSet,bCursorMoved){if(this.get("bNewId")){var rowdatas=oDataSet.RowData().get("aRowData");var lastIndex=rowdatas.length-1;this.get("aIds").push(rowdatas[lastIndex].id_data);$("#"+this.UniqId()).jqxGrid("addrow",null,rowdatas[lastIndex]);$("#"+this.UniqId()).jqxGrid("updatebounddata");this.set("bNewId",false);document.getElementById(this.UniqId()+this.get("sSuffixAddButton")).disabled=false;var columnName=$("#"+this.UniqId()).jqxGrid("columns").records[0].datafield;$("#"+this.UniqId()).jqxGrid("selectcell",lastIndex,columnName);var position=$("#"+this.UniqId()).jqxGrid("scrollposition");var height=$("#"+this.UniqId()).jqxGrid("height");$("#"+this.UniqId()).jqxGrid("scrolloffset",height,position.left);$("#"+this.UniqId()).jqxGrid("focus")}},Initialize:function(oConf){var that=this;var columns=new Array();var datafields=new Array();var gridWidth=0;var aColumnDefs=this.get("oWidgetDef").columns.column;for(var i=0;i<aColumnDefs.length;i++){var column={};var field={};column.datafield=aColumnDefs[i].f;column.text=aColumnDefs[i].title;column.width=aColumnDefs[i].width;gridWidth=gridWidth+parseInt(column.width);field.name=aColumnDefs[i].f;column.editable=true;if(aColumnDefs[i].readonly!=undefined&&Boolean(aColumnDefs[i].readonly)){column.editable=false}if(aColumnDefs[i].formula!=undefined){column.editable=false}column.pinned=false;if(aColumnDefs[i].pinned!=undefined&&Boolean(aColumnDefs[i].pinned)){column.pinned=true}column.aggregates=[];if(aColumnDefs[i].aggregate!=undefined){column.aggregates.push(aColumnDefs[i].aggregate)}column.cellsalign="left";if(aColumnDefs[i].cellsalign!=undefined){if(aColumnDefs[i].cellsalign=="right"||aColumnDefs[i].cellsalign=="center"){column.cellsalign=aColumnDefs[i].cellsalign}}if(aColumnDefs[i].cellsformat!=undefined){column.cellsformat=aColumnDefs[i].cellsformat}column.validation=function(cell,value){var minValue=that.DataSet().MetaData().GetFieldMin(cell.datafield);var maxValue=that.DataSet().MetaData().GetFieldMax(cell.datafield);if("date"==that.DataSet().MetaData().GetFieldType(cell.datafield)){value=value.getFullYear()+"-"+(1+value.getMonth())+"-"+value.getDate()}if(minValue&&value<minValue){return{result:false,message:cell.datafield+": '"+value+"' doit être supérieur ou égal à '"+minValue+"'"}}if(maxValue&&value>maxValue){return{result:false,message:cell.datafield+": '"+value+"' doit être inférieur ou égal à '"+maxValue+"'"}}return true};switch(this.DataSet().MetaData().GetFieldType(aColumnDefs[i].f)){case this.DataSet().MetaData().get("TYPE_PRIMARY_KEY"):field.type="number";column.editable=false;break;case this.DataSet().MetaData().get("TYPE_INTEGER"):field.type="number";column.columntype="numberinput";break;case this.DataSet().MetaData().get("TYPE_FLOAT"):field.type="number";column.columntype="textbox";break;case this.DataSet().MetaData().get("TYPE_DATE"):column.cellsformat="d";field.type="date";column.columntype="datetimeinput";break;case this.DataSet().MetaData().get("TYPE_TEXT"):field.type="string";column.columntype="textbox";break;case this.DataSet().MetaData().get("TYPE_DICO_EXT"):var dicoName=this.DataSet().MetaData().GetDicoExtName(aColumnDefs[i].f);var dicoDataSet=this.DataSet().get("oDataSetManager").DataSetDico(dicoName);var dicoValues=dicoDataSet.get("oRowData").get("aRowData");var dicoSource={datatype:"array",datafields:[{name:"label",type:"string"},{name:"id_data",type:"integer"}],localdata:dicoValues};var dicoAdapter=new $.jqx.dataAdapter(dicoSource,{autobind:true});field.type="string";column.columntype="template";column.createEditor=function(row,value,editor){editor.jqxDropDownList({checkboxes:true,source:dicoAdapter,displayMember:"label",valueMember:"id_data",autoDropDownHeight:"true",selectionRenderer:function(){return"Veuillez choisir:"}})};column.cellsrenderer=function(rowindex,columnfield,cellvalue){var name=that.DataSet().MetaData().GetDicoExtName(this.datafield);var dataSet=that.DataSet().get("oDataSetManager").DataSetDico(name);var items=dataSet.get("oRowData").get("aRowData");var labels=[];var value=[];if(typeof(cellvalue)=="string"){value=cellvalue.split(",")}for(var i=0;i<items.length;i++){var obj=items[i];for(var j=0;j<value.length;j++){if(obj.id_data==value[j]){labels.push(obj.label)}}}var result=labels.join(", ");return"<div style='margin:4px'>"+result+"</div>"};column.initEditor=function(row,cellvalue,editor,celltext,pressedkey){var items=editor.jqxDropDownList("getItems");editor.jqxDropDownList("uncheckAll");var values=cellvalue.split(",");for(var j=0;j<values.length;j++){for(var i=0;i<items.length;i++){if(items[i].value==values[j]){editor.jqxDropDownList("checkIndex",i)}}}};column.getEditorValue=function(row,cellvalue,editor){that.get("oDataSet").DataSetManager().SelectRowFromPrimaryKey(that.get("oDataSet"),that.get("aIds")[row]);var value=[];if(""!=editor.val()){value=editor.val().split(",")}that.get("oDataSet").DataSetManager().SetFieldValue(that.get("oDataSet").Field(this.datafield),value);var params={DIALOG_OPTIONS:{bDlgDisabled:true}};that.get("oDataSet").DataSetManager().get("oFrame").Save(null,params);return editor.val()};break;case this.DataSet().MetaData().get("TYPE_FKEY_VARSET"):var dicoName=aColumnDefs[i].d;var dicoDataSet=that.DataSet().get("oDataSetManager").DataSet(dicoName);var dicoValues=dicoDataSet.get("oRowData").get("aRowData");var dicoSource={datatype:"array",datafields:[{name:"label",type:"string"},{name:"id_data",type:"integer"}],localdata:dicoValues};var dicoAdapter=new $.jqx.dataAdapter(dicoSource,{autoBind:true});var dico={};dico.name="dico_"+i;if(aColumnDefs[i].ghost!=undefined){dico.name=aColumnDefs[i].ghost}dico.value=column.datafield;dico.values={source:dicoAdapter.records,value:"id_data",name:"label"};datafields.push(dico);field.type="string";column.columntype="combobox";column.displayfield=dico.name;column.createEditor=function(row,value,editor){var source;for(var i=0;i<datafields.length;i++){if(datafields[i].name==this.displayfield){source=datafields[i].values.source;source.unshift({id_data:null,label:""})}}var adapter=new $.jqx.dataAdapter(source,{autoBind:true});editor.jqxComboBox({source:adapter,displayMember:"label",valueMember:"id_data",dropDownHeight:75})};break;case this.DataSet().MetaData().get("TYPE_DICO"):var dicoName=this.DataSet().MetaData().GetDicoName(aColumnDefs[i].f);var dicoDataSet=this.DataSet().get("oDataSetManager").DataSetDico(dicoName);var dicoValues=dicoDataSet.get("oRowData").get("aRowData");var dicoSource={datatype:"array",datafields:[{name:"label",type:"string"},{name:"id_data",type:"integer"}],localdata:dicoValues};var dicoAdapter=new $.jqx.dataAdapter(dicoSource,{autoBind:true});var dico={};dico.name="dico_"+i;dico.value=column.datafield;dico.values={source:dicoAdapter.records,value:"id_data",name:"label"};datafields.push(dico);field.type="number";column.columntype="combobox";column.displayfield=dico.name;column.createEditor=function(row,value,editor){var name=that.DataSet().MetaData().GetDicoName(this.datafield);var dataSet=that.DataSet().get("oDataSetManager").DataSetDico(name);var localdata=dataSet.get("oRowData").get("aRowData");localdata.unshift({id_data:null,label:""});var dicoSource={datatype:"array",datafields:[{name:"label",type:"string"},{name:"id_data",type:"integer"}],localdata:localdata};var adapter=new $.jqx.dataAdapter(dicoSource,{autoBind:true});editor.jqxComboBox({source:adapter,displayMember:"label",valueMember:"id_data",dropDownHeight:75})};break;default:column.columntype="textbox";field.type="string";break}if(aColumnDefs[i].formula!=undefined){column.cellsrenderer=function(index,datafield,value,defaultvalue,column,rowdata){var update=false;var formula="";var cellsformat="";for(var i=0;i<aColumnDefs.length;i++){if(aColumnDefs[i].f==datafield){formula=aColumnDefs[i].formula;if(aColumnDefs[i].cellsformat!=undefined){cellsformat=aColumnDefs[i].cellsformat}}}var resultat=eval(formula);var formattedResultat=resultat;var type=that.DataSet().MetaData().GetFieldType(datafield);if(type==that.DataSet().MetaData().get("TYPE_STRING")){if(value!=resultat){update=true}}if(type==that.DataSet().MetaData().get("TYPE_INTEGER")||type==that.DataSet().MetaData().get("TYPE_FLOAT")){if(isNaN(resultat)){resultat="";formattedResultat=""}else{if(column.cellsformat){var da=new $.jqx.dataAdapter();formattedResultat=da.formatNumber(resultat,cellsformat,{decimalseparator:that.get("sDecimalSeparator"),thousandsseparator:that.get("sThousandSeparator")})}}if(value!=resultat){update=true}}if(type==that.DataSet().MetaData().get("TYPE_FKEY_VARSET")){for(var i=0;i<datafields.length;i++){if(datafields[i].name==this.displayfield){var s=datafields[i].values.source;for(var j=0;j<s.length;j++){if(s[j].id_data==resultat){formattedResultat=s[j].label}}}}if(resultat===null){formattedResultat=""}if(formattedResultat!=value){update=true;rowdata[this.displayfield]=formattedResultat}}if(that.get("iComputedIndex")==index&&update){var oComputedColumns=that.get("oComputedColumns");oComputedColumns[datafield]=resultat;that.set("oComputedColumns",oComputedColumns)}return"<div style='margin:4px; text-align: "+column.cellsalign+"'>"+formattedResultat+"</div>"}}columns.push(column);datafields.push(field)}var data=this.DataSet().RowData().get("aRowData");for(var i=0;i!=data.length;i++){this.get("aIds")[i]=data[i].id_data}var source={localdata:data,datatype:"array",datafields:datafields};var dataAdapter=new $.jqx.dataAdapter(source,{loadComplete:function(data){},loadError:function(xhr,status,error){}});$("#"+this.UniqId()).jqxGrid({editable:true,columns:columns,source:dataAdapter,selectionmode:"singlecell",scrollmode:"logical",theme:this.get("sTheme"),rowsheight:this.get("iRowsHeight"),columnsheight:this.get("iColumnsHeight"),width:this.get("iWidth"),height:this.get("iHeight"),sortable:this.get("bSortable"),showstatusbar:this.get("bShowStatusBar"),statusbarheight:this.get("iStatusBarHeight"),showaggregates:this.get("bShowAggregates"),columnsresize:this.get("bColumnResize"),filterable:this.get("bFilterable"),showfilterrow:this.get("bFilterRow")});var localizationobj={};var days={names:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],namesAbbr:["Dim","Lun","Mar","Mecr","Jeu","Ven","Sam"],namesShort:["Di","Lu","Ma","Me","Je","Ve","Sa"]};localizationobj.days=days;var months={names:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Décembre",""],namesAbbr:["Jan","Fev","Mar","Avr","Mai","Juin","Juil","Aou","Sep","Oct","Nov","Dec",""]};localizationobj.months=months;localizationobj.patterns={d:"dd/MM/yyyy",D:"dddd dd MMMM yyyy",t:"h:mm tt",T:"h:mm:ss tt",f:"dddd dd MMMM yyyy h:mm tt",F:"dddd dd MMMM yyyy h:mm:ss tt",M:"dd MMMM",Y:"MMMM yyyy",S:"yyyy\u0027-\u0027MM\u0027-\u0027dd\u0027T\u0027HH\u0027:\u0027mm\u0027:\u0027ss"};localizationobj.decimalseparator=this.get("sDecimalSeparator");localizationobj.thousandsseparator=this.get("sThousandSeparator");$("#"+this.UniqId()).jqxGrid("localizestrings",localizationobj);$("#"+this.UniqId()).bind("cellselect",function(event){that.get("oDataSet").DataSetManager().SelectRowFromPrimaryKey(that.get("oDataSet"),that.get("aIds")[args.rowindex])});$("#"+this.UniqId()).bind("cellbeginedit",function(event){that.set("iComputedIndex",event.args.rowindex);that.set("bCompute",false)});$("#"+this.UniqId()).bind("cellendedit",function(event){});$("#"+this.UniqId()).bind("cellvaluechanged",function(event){var args=event.args;var column=$("#"+that.UniqId()).jqxGrid("getcolumn",args.datafield);var fieldValue=args.value;var oComputedColumns=that.get("oComputedColumns");for(var f in oComputedColumns){$("#"+that.UniqId()).jqxGrid("setcellvalue",that.get("iComputedIndex"),f,oComputedColumns[f]);oComputedColumns[f]}that.set("oComputedColumns",{});if(column.columntype=="template"){return}if(typeof(args.value)=="object"&&args.value){fieldValue=args.value.value}else{if(column.columntype=="datetimeinput"&&args.value!=null){args.value.setHours(12);fieldValue=args.value.toISOString().substr(0,10)}}that.get("oDataSet").DataSetManager().SelectRowFromPrimaryKey(that.get("oDataSet"),that.get("aIds")[args.rowindex]);that.get("oDataSet").DataSetManager().SetFieldValue(that.get("oDataSet").Field(args.datafield),fieldValue);var params={DIALOG_OPTIONS:{bDlgDisabled:true}};that.get("oDataSet").DataSetManager().get("oFrame").Save(null,params)});$("#"+this.UniqId()).bind("cellselect",function(event){that.set("iRowIndex",event.args.rowindex)});$("#"+this.UniqId()+this.get("sSuffixAddButton")).bind("click",function(){that.get("oDataSet").DataSetManager().NewRecord(that.get("oDataSet"));var params={DIALOG_OPTIONS:{bDlgDisabled:true}};that.get("oDataSet").DataSetManager().get("oFrame").Save(null,params);that.set("bNewId",true);this.disabled=true});$("#"+this.UniqId()+this.get("sSuffixDeleteButton")).bind("click",function(){var rowscount=$("#"+that.UniqId()).jqxGrid("getdatainformation").rowscount;var selectedrowindex=that.get("iRowIndex");if(selectedrowindex>=0&&selectedrowindex<rowscount){var id=$("#"+that.UniqId()).jqxGrid("getrowid",selectedrowindex);var confirmMsg='Ligne "'+that.get("aIds")[selectedrowindex]+'"\n';confirmMsg+=that.get("sDeleteMsg");if(!window.confirm(confirmMsg)){return}var deleteIds=[];deleteIds.push(that.get("aIds")[selectedrowindex]);that.get("oDataSet").DataSetManager().DeleteRecords(that.get("oDataSet"),deleteIds);$("#"+that.UniqId()).jqxGrid("deleterow",id);for(var j=selectedrowindex;j<that.get("aIds").length;j++){that.get("aIds")[j]=that.get("aIds")[j+1]}that.get("aIds").pop();$("#"+that.UniqId()).jqxGrid("focus")}else{window.alert("Aucune ligne selectionnée");return}});$("#"+this.UniqId()+this.get("sSuffixExportButton")).bind("click",function(){var records=$("#"+that.UniqId()).jqxGrid("source").records;var columns=$("#"+that.UniqId()).jqxGrid("columns").records;var rows=[];for(var r=0;r<records.length;r++){var row={};for(var c=0;c<columns.length;c++){var f=columns[c].displayfield;var df=columns[c].datafield;row[df]=records[r][f]}rows.push(row)}$("#"+that.UniqId()).jqxGrid("exportdata","xls",that.UniqId(),true,rows,false,Y.Url.build({uri:"jqwidget/export/savefile"}),"utf8")});$("#"+this.UniqId()+this.get("sSuffixPrintButton")).bind("click",function(){var gridContent=$("#"+that.UniqId()).jqxGrid("exportdata","html");var popup=window.open("","","width=800, height=600");var d=popup.document.open();var htmlContent="<html><head><meta charset='utf-8' /></head><body>"+gridContent+"</body></html>";d.write(htmlContent);d.close();popup.print()});$("#"+this.UniqId()).jqxGrid("render")}})});